# Session du 29 Janvier 2026

## Objectif Principal
Implémentation des systèmes **Parrainage** et **NPS Survey** dans le cadre du framework AARRR (Phase 3 - Referral & Retention).

---

## Réalisations

### 1. Système de Parrainage (Referral) ✅

**Objectif** : Augmenter le taux de parrainage de 0% vers 10%

#### Fonctionnalités implémentées :
- **Page d'invitation personnalisée** : `/invite/[playerId]`
  - Affiche les infos du parrain (nom, ELO, club, matchs, taux de victoire)
  - Offre "Early Bird" mise en avant
  - CTA vers `/register?ref={playerId}`

- **Tracking des conversions** :
  - Capture du paramètre `?ref=` à l'inscription
  - États : `pending` → `completed` → `rewarded`
  - Triggers PostgreSQL pour mise à jour automatique des stats

- **Gamification** :
  - Badge **Ambassador** : 3 filleuls inscrits (Rare)
  - Badge **Networker** : 10 filleuls inscrits (Epic)
  - Attribution automatique via triggers

- **Section profil "Mes parrainages"** :
  - Lien de parrainage avec boutons copier/partager
  - Stats : inscrits, en attente, récompensés
  - Liste des filleuls avec ELO
  - Barres de progression vers les badges

- **Vue analytics** : `v_referral_analytics`
  - Métriques quotidiennes
  - Taux de conversion

#### Fichiers créés/modifiés :
- `migrations/referral-system.sql` - Migration complète
- `src/lib/referrals/service.ts` - Logique métier
- `src/app/api/referrals/route.ts` - API
- `src/app/(public)/invite/[playerId]/page.tsx` - Landing page
- `src/components/referrals/referral-section.tsx` - UI profil
- `src/lib/db/schema.ts` - Schéma Drizzle
- `src/lib/gamification/badges.ts` - Badges Ambassador/Networker

#### PR : [#5](https://github.com/PleneufMC/TennisMatchFinder/pull/5) - Mergée ✅

---

### 2. Système NPS Survey ✅

**Objectif** : Mesurer la satisfaction utilisateurs (Net Promoter Score)

#### Fonctionnalités implémentées :
- **Modal NPS** :
  - Score 0-10 avec couleurs (rouge→jaune→vert)
  - Feedback textuel optionnel
  - Option "Rappeler plus tard"

- **Déclenchement automatique** :
  - Après 5 matchs joués OU
  - Après 30 jours d'inscription
  - Cooldown de 90 jours entre les surveys

- **Dashboard Admin** (`/admin/nps`) :
  - Score NPS global (-100 à +100)
  - Distribution Promoteurs/Passifs/Détracteurs
  - Score moyen
  - Liste des réponses récentes avec feedback
  - Filtres par période

- **Calcul NPS** :
  - Détracteurs : 0-6
  - Passifs : 7-8
  - Promoteurs : 9-10
  - NPS = % Promoteurs - % Détracteurs

#### Fichiers créés/modifiés :
- `migrations/nps-survey.sql` - Migration
- `src/lib/nps/service.ts` - Logique métier
- `src/app/api/nps/route.ts` - API submission
- `src/app/api/nps/stats/route.ts` - API stats
- `src/components/nps/nps-survey-modal.tsx` - Modal UI
- `src/components/nps/nps-survey-trigger.tsx` - Trigger logic
- `src/app/(dashboard)/admin/nps/page.tsx` - Dashboard admin
- `src/app/(dashboard)/layout.tsx` - Intégration trigger

#### PR : [#6](https://github.com/PleneufMC/TennisMatchFinder/pull/6) - Mergée ✅

---

### 3. Corrections

- **Lien NPS dans le menu admin** : Ajouté dans la section "Super Administration"
  - PR : [#7](https://github.com/PleneufMC/TennisMatchFinder/pull/7) - Mergée ✅
- **Cache Netlify** : Résolu par redéploiement avec vidage du cache

---

## Migrations SQL Appliquées

### Parrainage
- Tables : `referrals`, `player_referral_stats`
- Enum : `referral_status`
- Triggers : `trg_update_referral_stats`, `trg_referrals_updated_at`
- Vue : `v_referral_analytics`
- Badges : `ambassador`, `networker`

### NPS
- Table : `nps_surveys`
- Vues : `v_nps_analytics`, `v_nps_global`

---

## État du Projet

| Système | Code | Migration | Déployé |
|---------|------|-----------|---------|
| Parrainage | ✅ | ✅ | ✅ |
| NPS Survey | ✅ | ✅ | ✅ |

---

## Liens Utiles

- **Test parrainage** : https://tennismatchfinder.net/invite/2255df4c-5ff2-40a8-af10-26545d816f91
- **Dashboard NPS** : https://tennismatchfinder.net/admin/nps
- **Netlify deploys** : https://app.netlify.com/sites/tennismatchfinder/deploys

---

## Prochaines Étapes (Roadmap AARRR)

1. **OAuth Google/Apple** - Réduire la friction d'inscription (Activation)
2. **Tracking UTM amélioré** - Attribution marketing (Acquisition)
3. **Notifications push parrainage** - Encourager le partage (Referral)

---

## Commits de la Session

```
ccb783b fix(admin): Add NPS Dashboard link to Super Administration menu (#7)
078ff45 feat(nps): Implement NPS Survey system for user satisfaction tracking (#6)
4b69a6e feat(referral): Implement complete referral system (Phase 3 AARRR) (#5)
```

---

## Notes Techniques

- **Stack** : Next.js 14, Drizzle ORM, PostgreSQL (Neon), Netlify
- **Branch de travail** : `genspark_ai_developer` → merge dans `main`
- **Build** : Tous les checks passent (TypeScript, ESLint, Next.js build)
