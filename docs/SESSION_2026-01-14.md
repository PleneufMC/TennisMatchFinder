# ğŸ“… Session de dÃ©veloppement - 14 janvier 2026

## ğŸ¯ Objectif de la session

**Sprint 4 : RÃ©putation & Social** - ImplÃ©menter le systÃ¨me d'Ã©valuation post-match pour construire la confiance au sein de la communautÃ©.

---

## âœ… Travail accompli

### 1. SystÃ¨me de RÃ©putation Post-Match â­

#### Concept
AprÃ¨s confirmation d'un match, le joueur peut Ã©valuer son adversaire sur 3 critÃ¨res :
- **PonctualitÃ©** : ArrivÃ©e Ã  l'heure, respect du planning
- **Fair-play** : Respect des rÃ¨gles, annonces honnÃªtes  
- **ConvivialitÃ©** : Attitude positive, bonne ambiance

#### Base de donnÃ©es

**Table `match_ratings`** :
| Colonne | Type | Description |
|---------|------|-------------|
| id | UUID | Identifiant unique |
| match_id | UUID FK | Match concernÃ© |
| rater_id | UUID FK | Joueur qui Ã©value |
| rated_player_id | UUID FK | Joueur Ã©valuÃ© |
| punctuality | INT (1-5) | Note ponctualitÃ© |
| fair_play | INT (1-5) | Note fair-play |
| friendliness | INT (1-5) | Note convivialitÃ© |
| comment | TEXT | Commentaire optionnel (privÃ©) |
| average_rating | DECIMAL(2,1) | Moyenne calculÃ©e |
| created_at | TIMESTAMP | Date de l'Ã©valuation |

**Colonnes ajoutÃ©es Ã  `players`** :
- `reputation_avg` : Moyenne gÃ©nÃ©rale
- `reputation_punctuality` : Moyenne ponctualitÃ©
- `reputation_fair_play` : Moyenne fair-play
- `reputation_friendliness` : Moyenne convivialitÃ©
- `reputation_count` : Nombre d'Ã©valuations reÃ§ues

#### API

**POST /api/matches/[matchId]/rate**
```json
// Request
{
  "punctuality": 5,
  "fairPlay": 4,
  "friendliness": 5,
  "comment": "TrÃ¨s bon partenaire !"
}

// Response
{
  "success": true,
  "rating": {...},
  "message": "Merci ! Votre Ã©valuation a Ã©tÃ© enregistrÃ©e.",
  "ratedPlayer": {
    "id": "...",
    "newAverage": "4.7",
    "totalRatings": 8
  }
}
```

**GET /api/matches/[matchId]/rate**
- RÃ©cupÃ¨re les Ã©valuations d'un match
- Indique si le joueur a dÃ©jÃ  Ã©valuÃ© (`hasRated`)
- Retourne l'Ã©valuation reÃ§ue si disponible

---

### 2. Composants UI

#### RatingModal (`src/components/reputation/rating-modal.tsx`)
- Modal de saisie avec systÃ¨me d'Ã©toiles interactif
- 3 critÃ¨res avec description
- Affichage de la moyenne en temps rÃ©el
- Commentaire optionnel (500 caractÃ¨res max)
- Animation de succÃ¨s aprÃ¨s envoi

#### ReputationBadge (`src/components/reputation/reputation-badge.tsx`)
- Badge affichÃ© sur le profil avec note moyenne
- Tooltip avec dÃ©tail des 3 critÃ¨res
- Coloration selon la note (vert/jaune/rouge)
- Badge spÃ©cial "Partenaire Fiable" (â­ 4.5+ avec 5+ avis)
- Version compacte pour les listes

---

### 3. IntÃ©gration dans le Flow

#### Confirmation de match (`match-confirm-form.tsx`)
1. Joueur confirme le rÃ©sultat
2. Message de succÃ¨s affichÃ©
3. **AprÃ¨s 1.5s** â†’ Modal d'Ã©valuation apparaÃ®t
4. Joueur peut Ã©valuer ou passer
5. Redirection vers /matchs

#### Page de profil (`profil/page.tsx`)
- Badge de rÃ©putation affichÃ© Ã  cÃ´tÃ© du rang ELO
- DÃ©tails visibles au survol (tooltip)

---

### 4. Badge "Partenaire Fiable" ğŸ…

**Conditions d'obtention** :
- Moyenne gÃ©nÃ©rale â‰¥ 4.5/5
- Au moins 5 Ã©valuations reÃ§ues

**CaractÃ©ristiques** :
- CatÃ©gorie : Social
- Tier : Rare (bleu)
- IcÃ´ne : UserCheck
- Couleur : Emerald (#10B981)

**IntÃ©gration** :
- AjoutÃ© Ã  `BADGE_DEFINITIONS` (17Ã¨me badge)
- Fonction `checkReliablePartner()` dans badge-checker
- VÃ©rifiÃ© automatiquement aprÃ¨s chaque nouvelle Ã©valuation

---

## ğŸ“ Fichiers crÃ©Ã©s/modifiÃ©s

### Nouveaux fichiers
```
src/
â”œâ”€â”€ app/api/matches/[matchId]/rate/
â”‚   â””â”€â”€ route.ts                        # API Ã©valuation
â”œâ”€â”€ components/reputation/
â”‚   â”œâ”€â”€ rating-modal.tsx                # Modal d'Ã©valuation
â”‚   â””â”€â”€ reputation-badge.tsx            # Badge rÃ©putation
â””â”€â”€ migrations/
    â””â”€â”€ reputation-system.sql           # Script SQL
```

### Fichiers modifiÃ©s
```
src/
â”œâ”€â”€ lib/db/
â”‚   â”œâ”€â”€ schema.ts                       # Table match_ratings + colonnes players
â”‚   â””â”€â”€ queries.ts                      # Query getNewMembersToWelcome
â”œâ”€â”€ lib/gamification/
â”‚   â”œâ”€â”€ badges.ts                       # Badge "Partenaire Fiable"
â”‚   â””â”€â”€ badge-checker.ts                # checkReliablePartner()
â”œâ”€â”€ lib/matching/
â”‚   â””â”€â”€ suggestion-engine.ts            # isNewMember + tag "Nouveau membre"
â”œâ”€â”€ types/
â”‚   â””â”€â”€ player.ts                       # isNewMember property
â”œâ”€â”€ components/matches/
â”‚   â””â”€â”€ match-confirm-form.tsx          # IntÃ©gration modal
â””â”€â”€ app/(dashboard)/
    â”œâ”€â”€ matchs/confirmer/[matchId]/page.tsx  # Passage des infos adversaire
    â”œâ”€â”€ profil/page.tsx                 # Affichage ReputationBadge
    â””â”€â”€ suggestions/page.tsx            # Section nouveaux membres
```

---

## ğŸ—„ï¸ Migration SQL Ã  exÃ©cuter

```sql
-- Fichier: migrations/reputation-system.sql
-- Statut: â³ Ã€ exÃ©cuter sur Neon

-- 1. CrÃ©er la table match_ratings
CREATE TABLE match_ratings (...);

-- 2. Ajouter les colonnes Ã  players
ALTER TABLE players 
ADD COLUMN reputation_avg DECIMAL(2,1),
ADD COLUMN reputation_punctuality DECIMAL(2,1),
ADD COLUMN reputation_fair_play DECIMAL(2,1),
ADD COLUMN reputation_friendliness DECIMAL(2,1),
ADD COLUMN reputation_count INTEGER DEFAULT 0;

-- 3. Ajouter le badge "Partenaire Fiable"
INSERT INTO badges (...) VALUES ('reliable-partner', ...);
```

---

### 5. "Nouveaux membres Ã  accueillir" ğŸ‘‹

#### Concept
Mettre en avant les nouveaux joueurs du club pour les intÃ©grer rapidement et encourager les anciens Ã  les accueillir.

#### CritÃ¨res d'identification
Un joueur est considÃ©rÃ© comme "nouveau membre" si :
- **Moins de 3 matchs** jouÃ©s
- **Inscrit depuis moins de 30 jours**

#### ImplÃ©mentation

**Query `getNewMembersToWelcome`** (`queries.ts`) :
```typescript
// RÃ©cupÃ¨re les nouveaux membres d'un club
export async function getNewMembersToWelcome(
  clubId: string,
  excludePlayerId?: string
): Promise<Player[]>
```

**Fonction `isNewMember`** (`suggestion-engine.ts`) :
```typescript
// VÃ©rifie si un joueur est un nouveau membre
export function isNewMember(opponent: SuggestionPlayer): boolean
```

#### UI - Page Suggestions

**Section dÃ©diÃ©e** (en haut de page) :
- Fond vert clair pour attirer l'attention
- IcÃ´ne HandHeart + titre "Nouveaux membres Ã  accueillir"
- Badge indiquant le nombre de nouveaux
- Liste compacte avec :
  - Avatar + Nom
  - ELO + Rang
  - "Inscrit il y a X jours"
  - Nombre de matchs jouÃ©s
  - Bouton "Proposer"

**Tag dans les suggestions** :
- Les nouveaux membres ont le tag `"Nouveau membre ğŸ‘‹"` prioritaire
- PropriÃ©tÃ© `isNewMember: boolean` ajoutÃ©e Ã  `SuggestedPlayer`

#### Lien avec le badge "ComitÃ© d'accueil"
- Badge existant : "ComitÃ© d'accueil" (Tier: Common)
- CritÃ¨re : ÃŠtre le premier adversaire de 5 nouveaux membres
- Cette feature facilite l'obtention du badge

---

### 6. Rappel d'inactivitÃ© (CRON Job) â°

#### Concept
Envoyer automatiquement une notification aux joueurs qui n'ont pas jouÃ© depuis 7 jours pour les encourager Ã  revenir sur les courts.

#### CritÃ¨res d'identification
Un joueur est considÃ©rÃ© comme "inactif" si :
- **7+ jours** depuis le dernier match (`lastMatchAt`)
- **Membre actif** d'un club
- **Pas de notification** d'inactivitÃ© envoyÃ©e dans les 7 derniers jours

#### ImplÃ©mentation

**Query `getInactivePlayers`** (`queries.ts`) :
```typescript
// RÃ©cupÃ¨re les joueurs inactifs depuis X jours
export async function getInactivePlayers(
  inactiveDays: number = 7,
  excludeAlreadyNotified: boolean = true
): Promise<Player[]>
```

**Helper `createInactivityNotification`** (`queries.ts`) :
```typescript
// CrÃ©e une notification d'inactivitÃ© personnalisÃ©e
export async function createInactivityNotification(
  playerId: string,
  daysSinceLastMatch: number
): Promise<void>
```

#### API Endpoint

**POST /api/cron/inactivity-reminder**
- Authentification via `CRON_SECRET` (Bearer token)
- RÃ©cupÃ¨re les joueurs inactifs
- Envoie les notifications
- Retourne les statistiques

**GET /api/cron/inactivity-reminder**
- Mode preview/test
- Retourne la liste des joueurs qui recevraient une notification
- Sans envoyer rÃ©ellement les notifications

#### Netlify Scheduled Function

**Fichier** : `netlify/functions/inactivity-reminder.mts`
- **Schedule** : `0 10 * * *` (10h UTC = 11h heure franÃ§aise)
- **FrÃ©quence** : Quotidienne
- Appelle l'API interne avec le CRON_SECRET

#### Message de notification
- **Type** : `inactivity_reminder`
- **Titre** : "ğŸ¾ On vous attend sur le court !"
- **Message** : PersonnalisÃ© selon la durÃ©e d'inactivitÃ©
  - 7-14 jours : "Cela fait un moment que vous n'avez pas jouÃ©..."
  - 14+ jours : "Cela fait plus de X jours que vous n'avez pas jouÃ©..."
- **Lien** : `/suggestions` (pour trouver un adversaire)

---

## ğŸ“Š Statistiques de la session

| MÃ©trique | Valeur |
|----------|--------|
| Fichiers crÃ©Ã©s | 6 |
| Fichiers modifiÃ©s | 10 |
| Lignes de code ajoutÃ©es | ~1500 |
| Commits | 5 |
| Migrations SQL | 1 |
| CRON Jobs | 1 |

---

## ğŸ”œ Prochaines Ã©tapes

### Sprint 4 âœ… TERMINÃ‰
- [x] ~~SystÃ¨me de rÃ©putation post-match~~ âœ…
- [x] ~~Badge "Partenaire Fiable"~~ âœ…
- [x] ~~"Nouveaux membres Ã  accueillir"~~ âœ…
- [x] ~~Rappel d'inactivitÃ© (CRON job)~~ âœ…
- [ ] Afficher rÃ©putation dans la liste des joueurs (optionnel)

### Sprint 5 (MonÃ©tisation)
- [ ] Page `/pricing`
- [ ] IntÃ©gration Stripe (dÃ©jÃ  configurÃ©)
- [ ] Plans Premium/Pro

---

## ğŸ”— Commits de la session

1. `bb56895` - feat(reputation): implement post-match rating system - Sprint 4
2. `335fb9c` - docs: update roadmap and add SESSION_2026-01-14
3. `17611eb` - feat(suggestions): add 'New members to welcome' section - Sprint 4
4. `f9ed7e6` - docs: update SESSION_2026-01-14 with new members feature
5. `0f5a38c` - feat(notifications): add inactivity reminder CRON job - Sprint 4

---

## ğŸ“ Fichiers crÃ©Ã©s (complet)

```
src/
â”œâ”€â”€ app/api/
â”‚   â”œâ”€â”€ matches/[matchId]/rate/route.ts     # API Ã©valuation
â”‚   â””â”€â”€ cron/inactivity-reminder/route.ts   # API CRON inactivitÃ©
â”œâ”€â”€ components/reputation/
â”‚   â”œâ”€â”€ rating-modal.tsx                    # Modal d'Ã©valuation
â”‚   â””â”€â”€ reputation-badge.tsx                # Badge rÃ©putation
migrations/
â””â”€â”€ reputation-system.sql                   # Script SQL rÃ©putation
netlify/functions/
â””â”€â”€ inactivity-reminder.mts                 # CRON Netlify
```

---

---

### 7. SystÃ¨me Anti-Churn : Auto-validation & Contestation ğŸ›¡ï¸

#### Concept
RÃ©duire le churn en automatisant la validation des matchs tout en permettant les contestations tardives pour les erreurs.

#### Configuration (`MATCH_VALIDATION_CONFIG`)
| ParamÃ¨tre | Valeur | Description |
|-----------|--------|-------------|
| `autoValidateAfterHours` | 24 | DÃ©lai avant auto-validation |
| `reminderAfterHours` | 6 | DÃ©lai avant rappel |
| `contestationWindowDays` | 7 | PÃ©riode de contestation aprÃ¨s validation |
| `maxContestationsPerMonth` | 3 | Limite de contestations par joueur |

#### Flux complet
1. **Pierre enregistre** le score (ex: "6-4, 6-2" pour Jean)
2. **Jean reÃ§oit** une notification + `autoValidateAt` = +24h
3. **AprÃ¨s 6h** â†’ Rappel envoyÃ© si pas d'action
4. **Si Jean confirme** â†’ ELO mis Ã  jour instantanÃ©ment
5. **Si Jean ne fait rien (24h)** â†’ Auto-validÃ©, ELO mis Ã  jour
6. **Si Jean conteste** â†’ Score en litige, admin notifiÃ©
7. **AprÃ¨s validation** â†’ Jean peut encore contester pendant 7 jours

#### Base de donnÃ©es - Nouvelles colonnes

**Auto-validation** :
- `auto_validated` : BOOLEAN - True si validÃ© automatiquement
- `auto_validate_at` : TIMESTAMP - Date prÃ©vue d'auto-validation
- `reminder_sent_at` : TIMESTAMP - Date d'envoi du rappel

**Contestation** :
- `contested` : BOOLEAN - True si contestÃ©
- `contested_by` : UUID FK - Joueur qui conteste
- `contested_at` : TIMESTAMP - Date de contestation
- `contest_reason` : TEXT - Raison fournie
- `contest_resolved_at` : TIMESTAMP - Date de rÃ©solution
- `contest_resolution` : VARCHAR - 'upheld' | 'rejected' | 'modified'

#### APIs crÃ©Ã©es

**POST /api/cron/auto-validate-matches**
- ExÃ©cutÃ© toutes les heures via Netlify
- Trouve les matchs avec `auto_validate_at <= NOW()`
- Auto-valide et met Ã  jour les ELO
- Envoie les notifications aux deux joueurs

**POST /api/cron/match-reminders**
- ExÃ©cutÃ© toutes les heures via Netlify
- Trouve les matchs en attente depuis 6h+
- Envoie un rappel au joueur qui doit confirmer

**POST /api/matches/[matchId]/contest**
- Permet Ã  un joueur de contester un match
- VÃ©rifie la limite de 3/mois
- Notifie l'adversaire et les admins du club

#### UI - Page de confirmation

**Countdown** : Alert amber affichant "Auto-validation dans Xh Xmin"

**Boutons** :
- âœ… "Confirmer le rÃ©sultat" (vert)
- âŒ "Ce rÃ©sultat est incorrect" (rouge, annule le match)
- ğŸš© "Contester officiellement" (amber, ouvre un dialog)

**Dialog de contestation** :
- Textarea pour la raison (min 10 caractÃ¨res)
- Warning sur les contestations abusives
- Indication de la limite mensuelle

#### Netlify Scheduled Functions

**auto-validate-matches.mts**
- Schedule : `0 * * * *` (toutes les heures)
- Appelle `/api/cron/auto-validate-matches`

**match-reminders.mts**
- Schedule : `0 * * * *` (toutes les heures)
- Appelle `/api/cron/match-reminders`

---

## ğŸ“ Fichiers crÃ©Ã©s - Mise Ã  jour

```
src/
â”œâ”€â”€ app/api/
â”‚   â”œâ”€â”€ matches/
â”‚   â”‚   â””â”€â”€ [matchId]/contest/route.ts      # API contestation
â”‚   â””â”€â”€ cron/
â”‚       â”œâ”€â”€ auto-validate-matches/route.ts  # CRON auto-validation
â”‚       â””â”€â”€ match-reminders/route.ts        # CRON rappels
â”œâ”€â”€ lib/constants/
â”‚   â””â”€â”€ validation.ts                       # Config validation
migrations/
â””â”€â”€ match-validation-contestation.sql       # Migration SQL
netlify/functions/
â”œâ”€â”€ auto-validate-matches.mts               # CRON Netlify
â””â”€â”€ match-reminders.mts                     # CRON Netlify
```

## ğŸ“Š Statistiques de la session - Mises Ã  jour

| MÃ©trique | Valeur |
|----------|--------|
| Fichiers crÃ©Ã©s | 12 |
| Fichiers modifiÃ©s | 14 |
| Lignes de code ajoutÃ©es | ~2700 |
| Commits | 7 |
| Migrations SQL | 2 |
| CRON Jobs | 3 |

---

## ğŸ”— Commits de la session (complet)

1. `bb56895` - feat(reputation): implement post-match rating system - Sprint 4
2. `335fb9c` - docs: update roadmap and add SESSION_2026-01-14
3. `17611eb` - feat(suggestions): add 'New members to welcome' section - Sprint 4
4. `f9ed7e6` - docs: update SESSION_2026-01-14 with new members feature
5. `0f5a38c` - feat(notifications): add inactivity reminder CRON job - Sprint 4
6. `91c6ae7` - feat(admin): add delete player functionality for super admins
7. `a237281` - feat(validation): implement match auto-validation and contestation system

---

## âš ï¸ Actions post-dÃ©ploiement requises

### 1. Migrations SQL Ã  exÃ©cuter sur Neon
```bash
# RÃ©putation
psql -f migrations/reputation-system.sql

# Validation/Contestation
psql -f migrations/match-validation-contestation.sql
```

### 2. Variables d'environnement Netlify
VÃ©rifier que `CRON_SECRET` est configurÃ© pour les 3 CRON jobs.

---

*Session terminÃ©e - 14 janvier 2026*
**Sprint 4 : RÃ©putation & Social - TERMINÃ‰ âœ…**
**SystÃ¨me Anti-Churn : Auto-validation & Contestation - TERMINÃ‰ âœ…**
